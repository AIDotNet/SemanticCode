<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:SemanticCode.ViewModels"
             xmlns:ui="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="SemanticCode.Pages.McpManagementView"
             x:DataType="vm:McpManagementViewModel">
    
    <ScrollViewer Padding="20">
        <StackPanel Spacing="20">
            
            <!-- Header -->
            <StackPanel Spacing="10">
                <TextBlock Text="MCP服务器管理" 
                          FontSize="24" 
                          FontWeight="Bold"/>
                <TextBlock Text="管理Model Context Protocol (MCP) 服务器，为Claude Code提供扩展功能" 
                          FontSize="14" 
                          Opacity="0.8"/>
            </StackPanel>

            <!-- Status Message -->
            <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="16"
                    IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                <TextBlock Text="{Binding StatusMessage}" 
                          FontSize="14"/>
            </Border>

            <!-- Action Buttons -->
            <StackPanel Orientation="Horizontal" Spacing="10">
                <Button Content="刷新状态"
                        Command="{Binding RefreshStatusCommand}"
                        IsEnabled="{Binding !IsLoading}">
                    <Button.Content>
                        <StackPanel Orientation="Horizontal" Spacing="5">
                            <ui:SymbolIcon Symbol="Refresh" FontSize="16"/>
                            <TextBlock Text="刷新状态"/>
                        </StackPanel>
                    </Button.Content>
                </Button>
                
                <Button Content="添加自定义服务器"
                        Command="{Binding ShowAddServerCommand}"
                        IsEnabled="{Binding !IsLoading}">
                    <Button.Content>
                        <StackPanel Orientation="Horizontal" Spacing="5">
                            <ui:SymbolIcon Symbol="Add" FontSize="16"/>
                            <TextBlock Text="添加自定义"/>
                        </StackPanel>
                    </Button.Content>
                </Button>
            </StackPanel>

            <!-- Add Server Panel -->
            <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="20"
                    IsVisible="{Binding IsAddingServer}">
                <StackPanel Spacing="15">
                    <TextBlock Text="添加新的MCP服务器" 
                              FontSize="18" 
                              FontWeight="SemiBold"/>
                    
                    <StackPanel Spacing="10">
                        <TextBlock Text="JSON配置:" 
                                  FontWeight="SemiBold"/>
                        <TextBox Text="{Binding NewServerJson}" 
                                AcceptsReturn="True"
                                TextWrapping="Wrap"
                                MinHeight="200"
                                FontFamily="Consolas"
                                Watermark="输入MCP服务器的JSON配置，例如:&#x0A;{&#x0A;  &quot;server1&quot;: {&#x0A;    &quot;command&quot;: &quot;npx&quot;,&#x0A;    &quot;args&quot;: [&quot;-y&quot;, &quot;@modelcontextprotocol/server-filesystem&quot;, &quot;/path/to/files&quot;],&#x0A;    &quot;env&quot;: {&#x0A;      &quot;KEY&quot;: &quot;value&quot;&#x0A;    }&#x0A;  }&#x0A;}"/>
                        
                        <TextBlock Text="配置说明:" 
                                  FontWeight="SemiBold"
                                  Margin="0,10,0,0"/>
                        <TextBlock Text="• 输入完整的MCP服务器配置JSON&#x0A;• 可以包含多个服务器配置&#x0A;• 每个服务器需要包含 command 和 args 字段&#x0A;• env 字段为可选环境变量"
                                  TextWrapping="Wrap"
                                  Opacity="0.8"/>
                    </StackPanel>
                    
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <Button Content="保存" 
                               Command="{Binding SaveNewServerCommand}"/>
                        <Button Content="取消" 
                               Command="{Binding CancelAddServerCommand}"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Current Servers Section -->
            <StackPanel Spacing="15">
                <TextBlock Text="已配置的MCP服务器" 
                          FontSize="18" 
                          FontWeight="SemiBold"/>
                
                <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        MinHeight="200">
                    
                    <Grid>
                        <ScrollViewer MaxHeight="400"
                                     IsVisible="{Binding McpServers.Count}">
                            <ItemsControl ItemsSource="{Binding McpServers}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="{DynamicResource DividerStrokeColorDefaultBrush}"
                                                BorderThickness="0,0,0,1"
                                                Padding="20,15">
                                            <Grid ColumnDefinitions="*,Auto">
                                                
                                                <!-- Server Info -->
                                                <StackPanel Grid.Column="0" Spacing="5">
                                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                                        <TextBlock Text="{Binding Name}" 
                                                                  FontWeight="SemiBold" 
                                                                  FontSize="16"/>
                                                        
                                                        <!-- Status Indicators -->
                                                        <Border Background="Green" 
                                                               CornerRadius="10" 
                                                               Padding="6,2"
                                                               IsVisible="{Binding IsRunning}">
                                                            <TextBlock Text="运行中" 
                                                                      Foreground="White" 
                                                                      FontSize="12"/>
                                                        </Border>
                                                        
                                                        <Border Background="Orange" 
                                                               CornerRadius="10" 
                                                               Padding="6,2"
                                                               IsVisible="{Binding !IsRunning}">
                                                            <TextBlock Text="未运行" 
                                                                      Foreground="White" 
                                                                      FontSize="12"/>
                                                        </Border>
                                                        
                                                        <Border Background="Red" 
                                                               CornerRadius="10" 
                                                               Padding="6,2"
                                                               IsVisible="{Binding !IsEnabled}">
                                                            <TextBlock Text="已禁用" 
                                                                      Foreground="White" 
                                                                      FontSize="12"/>
                                                        </Border>
                                                    </StackPanel>
                                                    
                                                    <TextBlock Text="{Binding Configuration.Command}" 
                                                              Opacity="0.8" 
                                                              FontFamily="Consolas"/>
                                                    
                                                    <TextBlock Text="{Binding ErrorMessage}" 
                                                              Foreground="Red" 
                                                              FontSize="12"
                                                              IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                                </StackPanel>
                                                
                                                <!-- Action Buttons -->
                                                <StackPanel Grid.Column="1" 
                                                           Orientation="Horizontal" 
                                                           Spacing="5">
                                                    
                                                    <Button ToolTip.Tip="启用服务器"
                                                           Command="{Binding $parent[UserControl].((vm:McpManagementViewModel)DataContext).EnableServerCommand}"
                                                           CommandParameter="{Binding}"
                                                           IsVisible="{Binding !IsEnabled}">
                                                        <ui:SymbolIcon Symbol="Play" FontSize="16"/>
                                                    </Button>
                                                    
                                                    <Button ToolTip.Tip="禁用服务器"
                                                           Command="{Binding $parent[UserControl].((vm:McpManagementViewModel)DataContext).DisableServerCommand}"
                                                           CommandParameter="{Binding}"
                                                           IsVisible="{Binding IsEnabled}">
                                                        <ui:SymbolIcon Symbol="Pause" FontSize="16"/>
                                                    </Button>
                                                    
                                                    <Button ToolTip.Tip="删除服务器"
                                                           Command="{Binding $parent[UserControl].((vm:McpManagementViewModel)DataContext).RemoveServerCommand}"
                                                           CommandParameter="{Binding}">
                                                        <ui:SymbolIcon Symbol="Delete" FontSize="16"/>
                                                    </Button>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        
                        <!-- Empty State -->
                        <StackPanel HorizontalAlignment="Center" 
                                   VerticalAlignment="Center"
                                   Spacing="10"
                                   IsVisible="{Binding !McpServers.Count}">
                            <ui:SymbolIcon Symbol="Code" 
                                          FontSize="48" 
                                          Opacity="0.5"/>
                            <TextBlock Text="暂无MCP服务器" 
                                      FontSize="16" 
                                      Opacity="0.8"
                                      HorizontalAlignment="Center"/>
                            <TextBlock Text="使用上方的添加功能来添加MCP服务器，所有服务器都将从Claude CLI同步" 
                                      TextWrapping="Wrap"
                                      TextAlignment="Center"
                                      Opacity="0.6"
                                      MaxWidth="300"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </StackPanel>
            
            <!-- Loading Indicator -->
            <StackPanel HorizontalAlignment="Center" 
                       Spacing="10"
                       IsVisible="{Binding IsLoading}">
                <ui:ProgressRing IsIndeterminate="True" Width="32" Height="32"/>
                <TextBlock Text="处理中..." HorizontalAlignment="Center"/>
            </StackPanel>
            
        </StackPanel>
    </ScrollViewer>
    
</UserControl>